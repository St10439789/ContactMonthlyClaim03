   @{
    ViewData["Title"] = "HR Dashboard";
}

    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>@ViewData["Title"]</title>

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

        <style>
            body {
                background-color: #f5f5f5;
            }

            .dashboard-card {
                margin-top: 40px;
                padding: 25px;
                background: #fff;
                border-radius: 12px;
                box-shadow: 0 0 10px rgba(0,0,0,0.05);
            }

            .status-approved {
                color: green;
                font-weight: bold;
            }

            .status-pending {
                color: orange;
                font-weight: bold;
            }

            .status-rejected {
                color: red;
                font-weight: bold;
            }

            .valid-row {
                background-color: #e7ffe7;
            }

            .invalid-row {
                background-color: #ffe2e2;
            }

            .action-buttons {
                display: flex;
                justify-content: center;
                gap: 8px;
            }

            td, th {
                text-align: center;
                vertical-align: middle;
            }

            .btn-back {
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 6px;
                padding: 8px 16px;
            }

                .btn-back:hover {
                    background-color: #0056b3;
                }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mt-4 mb-4">
                <h2>🎓 @ViewData["Title"]</h2>
                <a href="/Home/Index" class="btn-back">🏠 Back to Home.</a>
            </div>

            <div class="dashboard-card table-responsive">
                <h5 class="mb-3">Submitted Claims for Verification & Approval</h5>

                <table class="table table-bordered table-hover align-middle" id="hrTable">
                    <thead class="table-light">
                        <tr>
                            <th>Claim ID</th>
                            <th>Lecturer Name</th>
                            <th>Sessions</th>
                            <th>Hours</th>
                            <th>Amount/Session</th>
                            <th>Total Amount</th>
                            <th>Submitted Date</th>
                            <th>Pre-Approved</th>
                            <th>Pre-Approved Date</th>
                            <th>Coordinator Status</th>
                            <th>Verification</th>
                            <th>Status</th>
                            <th>Document</th>
                            <th>Review</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if(Model != null && Model.Any())
                        {
                        foreach(var claim in Model)
                        {
                        <tr data-hours="@claim.Hours" data-sessions="@claim.Sessions" data-rate="@claim.AmountPerSession" data-total="@claim.TotalAmount">
                            <td>@claim.ClaimID</td>
                            <td>@claim.LecturerName ?? "N/A"</td>
                            <td>@claim.Sessions</td>
                            <td>@claim.Hours</td>
                            <td>R@claim.AmountPerSession</td>
                            <td>R@claim.TotalAmount</td>
                            <td>@claim.SubmittedDate?.ToString("dd MMM yyyy") ?? "-"</td>
                            <td>@(claim.PreApproved ? "Yes" : "No")</td>
                            <td>@claim.PreApprovedDate?.ToString("dd MMM yyyy") ?? "-"</td>
                            <td class="text-primary">@claim.CoordinatorStatus ?? "Pending"</td>
                            <td class="verification"></td>
                            <td class="status @(claim.Status ?? " status-pending")">@claim.Status ?? "Pending"</td>
                            <td><a href="@claim.DocumentUrl ?? " #"">View</a></td>
                            <td class="action-buttons">
                                @if(claim.Status == null || claim.Status == "Pending")
                                {
                                <button class="btn btn-success btn-sm btn-final-approve">Approve</button>
                                <button class="btn btn-danger btn-sm btn-final-reject">Reject</button>
                                }
                                else
                                {
                                <button class="btn btn-outline-secondary btn-sm" disabled>@claim.Status</button>
                                }
                            </td>
                        </tr>
                        }
                        }
                        else
                        {
                        <tr>
                            <td colspan="14">No claims found.</td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <script>
            function verifyClaim(row) {
                let hours = row.data("hours") || 0;
                let sessions = row.data("sessions") || 0;
                let rate = row.data("rate") || 0;
                let total = row.data("total") || 0;

                let errors = [];
                if (hours !== sessions * 2) errors.push("Hours must equal sessions × 2");
                if (total !== sessions * rate) errors.push("Total must equal sessions × rate");
                if (rate > 200) errors.push("Rate exceeds allowed maximum (R200)");
                return errors;
            }

            $(document).ready(function () {
                $("#hrTable tbody tr").each(function () {
                    const row = $(this);
                    const verificationCell = row.find(".verification");
                    const errors = verifyClaim(row);

                    if (errors.length > 0) {
                        row.addClass("invalid-row");
                        verificationCell.html("❌ Issues Detected").addClass("text-danger").attr("title", errors.join("\n"));
                    } else {
                        row.addClass("valid-row");
                        verificationCell.html("✔ Verified OK").addClass("text-success");
                    }
                });

                $(".btn-final-approve").click(function () {
                    const row = $(this).closest("tr");
                    const errors = verifyClaim(row);
                    if (errors.length > 0) {
                        alert("This claim contains policy conflicts:\n\n" + errors.join("\n"));
                        return;
                    }
                    row.find(".status").removeClass("status-pending status-rejected").addClass("status-approved").text("Approved");
                    row.find(".btn-final-reject").remove();
                    $(this).removeClass("btn-success").addClass("btn-outline-secondary").prop("disabled", true).text("Approved ✅");
                });

                $(".btn-final-reject").click(function () {
                    if (!confirm("Reject this claim permanently?")) return;
                    const row = $(this).closest("tr");
                    row.find(".status").removeClass("status-pending status-approved").addClass("status-rejected").text("Rejected");
                    row.find(".btn-final-approve").remove();
                    $(this).removeClass("btn-danger").addClass("btn-outline-secondary").prop("disabled", true).text("Rejected ❌");
                });
            });
        </script>
    </body>
</html>

